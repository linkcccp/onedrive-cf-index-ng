# ğŸ”§ 500 é”™è¯¯æ·±åº¦è¯Šæ–­æŒ‡å—

## é—®é¢˜çŠ¶æ€

API ä»ç„¶è¿”å› **500 Internal Server Error**ã€‚å“åº”å¤´æ˜¾ç¤º `cf-cache-status: DYNAMIC`ï¼Œè¯´æ˜è¯·æ±‚åˆ°è¾¾äº† Cloudflare æœåŠ¡å™¨ï¼Œä½†åœ¨å¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™ã€‚

---

## ğŸ¯ ç«‹å³å°è¯•ï¼šä½¿ç”¨è°ƒè¯• API

æˆ‘å·²ç»åˆ›å»ºäº†ä¸€ä¸ªç®€åŒ–çš„è°ƒè¯• API æ¥æµ‹è¯• Edge Runtime çš„åŸºæœ¬åŠŸèƒ½ã€‚

### ç¬¬ 1 æ­¥ï¼šéƒ¨ç½²è°ƒè¯• API

```bash
# ä»£ç å·²åˆ›å»ºåœ¨ï¼š
# src/pages/api/Linkcccp_debug.ts

# æäº¤å¹¶æ¨é€
git add src/pages/api/Linkcccp_debug.ts
git add src/pages/api/Linkcccp_generateIndex.ts
git commit -m "fix: improve Edge Runtime compatibility and add debug API"
git push
```

### ç¬¬ 2 æ­¥ï¼šæµ‹è¯•è°ƒè¯• API

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š
```
https://onedrive.linkcf.top/api/Linkcccp_debug
```

**é¢„æœŸå“åº”** (200 OK):
```json
{
  "success": true,
  "message": "All Edge Runtime tests passed",
  "tests": {
    "textEncoder": { "status": "passed", "size": 20 },
    "dateFormatting": { "status": "passed", "time": "2026-01-14 14:30:45" },
    "localeCompare": { "status": "passed", "sorted": ["123", "abc", "ä¸­æ–‡", "æ–‡ä»¶"] },
    "jsonSerialization": { "status": "passed", "length": 350 }
  },
  "duration": "0.02s"
}
```

å¦‚æœçœ‹åˆ° **200 OK**ï¼Œè¯´æ˜ Edge Runtime åŸºæœ¬åŠŸèƒ½æ­£å¸¸ã€‚
å¦‚æœçœ‹åˆ° **500 é”™è¯¯**ï¼Œé—®é¢˜å‡ºåœ¨ Edge Runtime æœ¬èº«ã€‚

---

## ğŸ“‹ æ ¹æ®è°ƒè¯•ç»“æœè¿›è¡Œåˆ¤æ–­

### åœºæ™¯ 1ï¼šè°ƒè¯• API è¿”å› 200 OK

âœ… è¯´æ˜ï¼šEdge Runtime åŸºæœ¬åŠŸèƒ½æ­£å¸¸

**ä¸‹ä¸€æ­¥**ï¼š
1. æ£€æŸ¥ access token æ˜¯å¦æœ‰æ•ˆ
2. æ£€æŸ¥ OneDrive API æ˜¯å¦å¯è®¿é—®
3. æŸ¥çœ‹å®Œæ•´çš„é”™è¯¯æ—¥å¿—

**æµ‹è¯• access token**:
```bash
# åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æ‰‹åŠ¨è°ƒç”¨åŸå§‹ API
# ç¡®ä¿å·²è®¤è¯ï¼Œç„¶åç‚¹å‡»"Index"æŒ‰é’®
# æŸ¥çœ‹ Network ä¸­çš„å“åº”å†…å®¹
```

### åœºæ™¯ 2ï¼šè°ƒè¯• API è¿”å› 500 é”™è¯¯

âŒ è¯´æ˜ï¼šEdge Runtime æœ‰å…¼å®¹æ€§é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. Cloudflare å·²æ”¯æŒ TextEncoderã€Dateã€localeCompare
2. å¦‚æœè°ƒè¯• API ä¹Ÿå¤±è´¥ï¼Œå¯èƒ½æ˜¯ï¼š
   - Cloudflare Workers ç‰ˆæœ¬é—®é¢˜
   - éƒ¨ç½²é…ç½®é—®é¢˜
   - å…¶ä»–ç³»ç»Ÿçº§åˆ«çš„é—®é¢˜

**å¯¹ç­–**ï¼š
- æŸ¥çœ‹ Cloudflare Dashboard çš„é”™è¯¯æ—¥å¿—
- å°è¯•é‡æ–°éƒ¨ç½²
- è”ç³» Cloudflare æ”¯æŒ

---

## ğŸ” æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

### æ–¹æ³• 1ï¼šCloudflare Workers æ—¥å¿—

è®¿é—® Cloudflare Dashboardï¼š
1. Pages â†’ é¡¹ç›® â†’ Functions â†’ æŸ¥çœ‹æ—¥å¿—
2. æœç´¢ `Linkcccp_generateIndex` æˆ– `Error`
3. æŸ¥çœ‹å®Œæ•´çš„é”™è¯¯å †æ ˆ

### æ–¹æ³• 2ï¼šæµè§ˆå™¨å¼€å‘å·¥å…·

1. æ‰“å¼€ F12
2. Network æ ‡ç­¾ â†’ ç‚¹å‡» `Linkcccp_generateIndex` è¯·æ±‚
3. Response æ ‡ç­¾ â†’ æŸ¥çœ‹å®Œæ•´å“åº”å†…å®¹

---

## ğŸ’¡ å¯èƒ½çš„åŸå› åˆ†æ

### åŸå›  1ï¼šgetAccessToken() å¤±è´¥

**ç—‡çŠ¶**ï¼š
- è°ƒè¯• API å·¥ä½œï¼Œä½†ç”Ÿæˆ API å¤±è´¥
- å¯èƒ½è¿”å› 403 æˆ– 401

**è§£å†³**ï¼š
```bash
# ç¡®ä¿å·²è¿›è¡Œ OAuth è®¤è¯
# 1. ç‚¹å‡»"Logout"
# 2. é‡æ–°ç™»å½•
# 3. å†è¯•ä¸€æ¬¡
```

### åŸå›  2ï¼šfetchAllItems() ä¸­çš„é€’å½’å‡ºé”™

**ç—‡çŠ¶**ï¼š
- å¼€å§‹è·å–æ–‡ä»¶ï¼Œç„¶åå¤±è´¥
- å¯èƒ½å› ä¸ºç‰¹æ®Šæ–‡ä»¶åæˆ–æƒé™é—®é¢˜

**è§£å†³**ï¼š
- æ£€æŸ¥ OneDrive ä¸­æ˜¯å¦æœ‰ç‰¹æ®Šæ–‡ä»¶å
- æ£€æŸ¥æ˜¯å¦æœ‰æƒé™è®¿é—®æ‰€æœ‰æ–‡ä»¶

### åŸå›  3ï¼šuploadIndexFile() ä¸Šä¼ å¤±è´¥

**ç—‡çŠ¶**ï¼š
- ç”Ÿæˆå†…å®¹æˆåŠŸï¼Œä½†ä¸Šä¼ å¤±è´¥
- çŠ¶æ€ç  400, 401, 403, 404

**è§£å†³**ï¼š
- æ£€æŸ¥æ˜¯å¦æœ‰å†™å…¥æƒé™
- æ£€æŸ¥ OneDrive æ ¹ç›®å½•æ˜¯å¦å¯å†™

---

## ğŸ› ï¸ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

### 1. ç®€åŒ– APIï¼ˆç¦ç”¨ä¸Šä¼ ï¼‰

ç¼–è¾‘ `src/pages/api/Linkcccp_generateIndex.ts`ï¼Œæ³¨é‡Šæ‰ä¸Šä¼ éƒ¨åˆ†ï¼š

```typescript
// ä¸Šä¼ åˆ° OneDrive
// console.log('ğŸ“¤ Uploading index.md to OneDrive...')
// await uploadIndexFile(accessToken, indexContent)

// ä¸´æ—¶è¿”å›æˆåŠŸï¼ˆä¸å®é™…ä¸Šä¼ ï¼‰
console.log('âš ï¸ Upload disabled for debugging')
```

### 2. å¢åŠ æ—¥å¿—è¯¦åº¦

ä»£ç å·²ç»åŒ…å«è¯¦ç»†çš„æ—¥å¿—ã€‚æŸ¥çœ‹ Cloudflare æ—¥å¿—ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚

### 3. æœ¬åœ°æµ‹è¯•

å¦‚æœå¯èƒ½ï¼Œä½¿ç”¨ `wrangler dev` åœ¨æœ¬åœ°æµ‹è¯•ï¼š

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
wrangler dev

# è®¿é—® http://localhost:8787/api/Linkcccp_generateIndex
```

---

## ğŸ“Š æ•…éšœæ’é™¤æµç¨‹å›¾

```
500 é”™è¯¯
  â†“
è°ƒè¯• API æµ‹è¯•
  â”œâ”€ 200 OK (âœ… Edge Runtime æ­£å¸¸)
  â”‚   â”œâ”€ access token æµ‹è¯•
  â”‚   â”œâ”€ æ–‡ä»¶è·å–æµ‹è¯•
  â”‚   â””â”€ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•
  â”‚
  â””â”€ 500 é”™è¯¯ (âŒ Edge Runtime é—®é¢˜)
      â”œâ”€ æ£€æŸ¥ Cloudflare æ—¥å¿—
      â”œâ”€ å°è¯•é‡æ–°éƒ¨ç½²
      â””â”€ è”ç³» Cloudflare æ”¯æŒ
```

---

## ğŸ“ æ¸…å•

è¿›è¡Œä»¥ä¸‹æ£€æŸ¥ï¼Œé€ä¸€æ’é™¤é—®é¢˜ï¼š

- [ ] éƒ¨ç½²äº†æœ€æ–°ä»£ç ï¼ˆåŒ…æ‹¬ Bug ä¿®å¤ï¼‰
- [ ] æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆCtrl+Shift+Delï¼‰
- [ ] åˆ·æ–°é¡µé¢ï¼ˆCtrl+F5ï¼‰
- [ ] æµ‹è¯•è°ƒè¯• API æ˜¯å¦è¿”å› 200
- [ ] ç‚¹å‡» Logout å¹¶é‡æ–°è®¤è¯
- [ ] å†æ¬¡å°è¯•ç‚¹å‡» Index æŒ‰é’®
- [ ] æŸ¥çœ‹ Cloudflare Workers æ—¥å¿—
- [ ] æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„ç½‘ç»œè¯·æ±‚

---

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Šæ­¥éª¤éƒ½ä¸èƒ½è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. è°ƒè¯• API çš„å“åº”å†…å®¹ (`/api/Linkcccp_debug`)
2. Cloudflare Workers æ—¥å¿—çš„å®Œæ•´é”™è¯¯ä¿¡æ¯
3. æµè§ˆå™¨ Network æ ‡ç­¾ä¸­çš„å®Œæ•´è¯·æ±‚/å“åº”
4. æ‚¨ä½¿ç”¨çš„ OneDrive ç±»å‹ï¼ˆä¸ªäºº/ä¼ä¸š/E5 ç­‰ï¼‰
5. `site.config.js` ä¸­çš„ `baseDirectory` é…ç½®

---

## ğŸ”„ ä»£ç æ”¹è¿›

æœ€æ–°ä¿®å¤åŒ…æ‹¬ï¼š

âœ… ä½¿ç”¨ `TextEncoder` ä»£æ›¿ `Buffer.byteLength`
âœ… ä¼˜åŒ– `localeCompare` çš„é”™è¯¯å¤„ç†
âœ… æ”¹è¿›é”™è¯¯æ—¥å¿—è¯¦åº¦
âœ… æ·»åŠ è°ƒè¯• API ç”¨äºæµ‹è¯•åŸºæœ¬åŠŸèƒ½
