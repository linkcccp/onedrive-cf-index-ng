# OneDrive 索引自动生成功能 (Linkcccp_generateIndex) - 开发与维护全手册

## 1. 功能概述 (大白话版)
OneDrive 原生的搜索功能对中文支持非常糟糕，经常搜不到文件或者结果不全。为了解决这个问题，我们添加了“索引自动生成”功能。

- **它干了什么**：点击导航栏的 **Index** 按钮后，程序会自动把你的**网站根目录**（即你在 `site.config.js` 中设置的 `baseDirectory` 文件夹，而不是整个 OneDrive）翻个底朝天，列成一张详细的文件清单（Markdown 格式文件树），并保存为 `index.md` 存回该目录。
- **有什么用**：有了这张清单，你只需要在浏览器里打开它，按 `Ctrl + F` 就能秒搜任何文件名（包括中文！），点击链接就能直接看文件，彻底绕过 OneDrive 难用的搜索。
- **保存位置**：保存在你设置的**网站根目录**（即 `site.config.js` 中配置的 `baseDirectory` 文件夹）下。

---

## 2. 核心技术实现

### 2.1 递归遍历与分页处理 (核心改进 1)
为了支持极大的文件夹（超过 200 个文件），我们实现了健壮的分页逻辑。
- **逻辑**：使用 `while (nextLink)` 循环逐页请求。
- **关键点**：严格检查微软 API 返回的 `@odata.nextLink` 字段。只有当该字段不存在时，才认为当前文件夹遍历完成。
- **重试机制**：针对网络不稳导致的 429 (限流) 或 503 (服务不可用) 错误，实现了指数退避重试（最多 3 次）。

### 2.2 路径编码处理 (核心改进 2)
为了确保中文路径在生成的 Markdown 中点击有效，我们实现了 `encodeUrlPath` 函数。
- **原理**：将路径按 `/` 分割，每一段使用 `encodeURIComponent` 单独编码，再拼接。
- **优点**：避免了整体编码导致的 `/` 被转义，同时确保了中文、空格等特殊字符在所有浏览器中都能正确识别。

### 2.3 Markdown 特殊符号转义 (核心改进 3)
文件名中经常包含 `[` `]` `(` `)` `*` 等 Markdown 特殊字符，这些符号会破坏文件树的排版。
- **功能**：实现了 `escapeMarkdownSpecialChars` 函数，转义了 11 种关键符号。
- **效果**：如文件名 `test [1].txt` 会被处理成 `test \[1\].txt`，确保链接格式依然合法。

---

## 3. Cloudflare Edge Runtime 兼容性修复

由于 API 运行在 Cloudflare Workers 的 Edge Runtime 中，不支持某些标准的 Node.js API，我们进行了以下针对性修复：

- **内容长度计算**：弃用了在 Edge 环境不稳定的 `new Blob().size`，改用 `Buffer.byteLength(indexContent, 'utf-8')` 来准确计算上传文件的大小。
- **日期时间格式化**：弃用了依赖国际化库的 `toLocaleString()`，改用原生 `Date` 方法手动拼接成 `YYYY-MM-DD HH:mm:ss` 格式，确保在边缘节点上表现一致。
- **HTTP 客户端**：结合使用了 `redaxios` 进行通用请求处理，确保轻量且高效。

---

## 4. 安全保护机制

- **访问密钥 (ACCESS_KEY)**：在 Cloudflare 环境变量中设置 `LINKCCCP_ACCESS_KEY`；前端请求时会进行验证，防止恶意用户无限触发生成任务。
- **权限范围**：需要将 API 配置中的 Scope 从 `Files.Read.All` 升级为 `Files.ReadWrite.All`，否则程序无法将 `index.md` 写回你的 OneDrive。
- **来源验证**：在生产环境下验证 `Referer`，确保 API 只能从本站发起，防止跨站调用。

---

## 5. 前端交互流程

1. **按钮显示**：在导航栏右侧添加了一个带有 📄 图标的 **Index** 按钮。
2. **生成反馈**：点击后按钮进入加载状态（旋转动画），并在操作成功后弹出 Toast 通知。
3. **性能体验**：通过异步加载和流式处理，生成 1000 个文件的索引通常在 10 秒内完成。

---

## 6. 测试与验证清单

如果您修改了代码，请务必进行以下检查：
- [ ] **分页测试**：确保在一个包含 200 个以上文件的文件夹里，索引仍然完整。
- [ ] **中文路径**：创建一个中文命名的文件夹，确认索引里的链接点开不报 404。
- [ ] **特殊字符**：创建一个包含 `[` 或 `#` 的文件，确认 Markdown 渲染没有乱掉。
- [ ] **权限检查**：确保 OneDrive 根目录下确实出现（或更新了）`index.md`。

---

## 7. 常见问题排查 (Troubleshooting)

### API 返回 500 错误
- **检查**：Cloudflare 后台日志。
- **常见原因**：可能是因为没有写入权限。请检查 `api.config.js` 里的 `scope` 设置是否已包含 `files.readwrite.all`。

### 索引文件不完整
- **检查**：生成的日志中有无循环报错。
- **关键代码**：查看 `src/pages/api/Linkcccp_generateIndex.ts` 中的 `fetchAllItems` 逻辑。

### 按钮点击没反应
- **检查**：浏览器 F12 网络请求。
- **常见原因**：`LINKCCCP_ACCESS_KEY` 在前端 `Navbar.tsx` 中未正确配置。

---

## 8. 性能参考
- **100 文件**：约 1-2 秒
- **1000 文件**：约 5-10 秒
- **5000 文件**：约 20-30 秒（接近 Cloudflare 30秒限制阈值，建议分文件夹生成）

---
*文档合并日期：2026-01-15*
